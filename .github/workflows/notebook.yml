name: CI/CD SageMaker Notebook

on:
  push:
    branches: [main]

jobs:
  deploy-notebook:
    runs-on: ubuntu-latest

    env:
      AWS_REGION: us-east-1                
      S3_BUCKET: order-567                      
      INSTANCE_NAME: testing                  
      LOCAL_NOTEBOOK_PATH: train_model.ipynb
      S3_NOTEBOOK_PATH: notebooks/train_model.ipynb

    steps:
      - name: ‚úÖ Checkout Repository
        uses: actions/checkout@v3

      - name: üîê Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: üì§ Upload Notebook to S3
        run: |
          echo "üìÅ Upload $LOCAL_NOTEBOOK_PATH ke s3://$S3_BUCKET/$S3_NOTEBOOK_PATH..."
          aws s3 cp $LOCAL_NOTEBOOK_PATH s3://$S3_BUCKET/$S3_NOTEBOOK_PATH
          echo "‚úÖ Upload sukses"

      - name: üöÄ Start SageMaker Notebook Instance
        run: |
          echo "üöÄ Menyalakan SageMaker Notebook Instance: $INSTANCE_NAME..."
          aws sagemaker start-notebook-instance --notebook-instance-name $INSTANCE_NAME
          echo "‚åõ Tunggu instance menyala..."

      - name: ‚è≥ Wait Until Notebook Ready
        run: |
          echo "üîç Mengecek status instance..."
          for i in {1..30}; do
            STATUS=$(aws sagemaker describe-notebook-instance \
              --notebook-instance-name $INSTANCE_NAME \
              --query 'NotebookInstanceStatus' \
              --output text)

            echo "Status sekarang: $STATUS"

            if [[ "$STATUS" == "InService" ]]; then
              echo "‚úÖ Notebook siap dijalankan!"
              exit 0
            fi
            sleep 20
          done
          echo "‚ùå Gagal: Notebook tidak siap dalam 10 menit"
          exit 1
