name: CI/CD SageMaker Notebook

on:
  push:
    paths:
      - 'notebooks/train_model.ipynb'

jobs:
  deploy-notebook:
    runs-on: ubuntu-latest

    env:            
      S3_BUCKET: order-567                        
      INSTANCE_NAME: testing           
      LOCAL_NOTEBOOK_PATH: notebooks/train_model.ipynb
      S3_NOTEBOOK_PATH: notebooks/train_model.ipynb

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Setup AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Upload Notebook to S3
        run: |
          echo "Upload $LOCAL_NOTEBOOK_PATH ke S3..."
          aws s3 cp $LOCAL_NOTEBOOK_PATH s3://$S3_BUCKET/$S3_NOTEBOOK_PATH
          echo "✅ Sukses upload"

      - name: Start SageMaker Notebook Instance
        run: |
          echo "Menyalakan instance SageMaker..."
          aws sagemaker start-notebook-instance --notebook-instance-name $INSTANCE_NAME

      - name: Wait Until Notebook Ready
        run: |
          echo "Menunggu notebook instance siap..."
          for i in {1..30}; do
            STATUS=$(aws sagemaker describe-notebook-instance \
              --notebook-instance-name $INSTANCE_NAME \
              --query 'NotebookInstanceStatus' \
              --output text)

            echo "Status sekarang: $STATUS"

            if [[ "$STATUS" == "InService" ]]; then
              echo "✅ Notebook siap!"
              exit 0
            fi
            sleep 20
          done
          echo "❌ Gagal: Notebook tidak siap dalam 10 menit"
          exit 1
