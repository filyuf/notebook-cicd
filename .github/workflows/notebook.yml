name: Deploy to SageMaker

on:
  push:
    branches: [ main ]

env:
  AWS_REGION: us-east-1
  S3_BUCKET: order-567
  S3_NOTEBOOK_KEY: notebooks/notebook.ipynb
  S3_REQUIREMENTS_KEY: notebooks/requirements.txt
  INSTANCE_NAME: test
  LIFECYCLE_CONFIG_NAME: auto-deploy-config

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üîê Configure AWS credentials with session token
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ‚òÅÔ∏è Upload notebook & requirements.txt to S3
        run: |
          aws s3 cp notebook.ipynb s3://${S3_BUCKET}/${S3_NOTEBOOK_KEY}
          aws s3 cp requirements.txt s3://${S3_BUCKET}/${S3_REQUIREMENTS_KEY}

      - name: üõ†Ô∏è Create lifecycle configuration script
        run: |
          printf '#!/bin/bash\nset -e\nNOTEBOOK_DIR=/home/ec2-user/SageMaker/notebooks\nmkdir -p "$NOTEBOOK_DIR"\naws s3 cp s3://${S3_BUCKET}/${S3_NOTEBOOK_KEY} "$NOTEBOOK_DIR/notebook.ipynb"\naws s3 cp s3://${S3_BUCKET}/${S3_REQUIREMENTS_KEY} "$NOTEBOOK_DIR/requirements.txt"\npip install -r "$NOTEBOOK_DIR/requirements.txt"\npip install papermill\npapermill "$NOTEBOOK_DIR/notebook.ipynb" "$NOTEBOOK_DIR/output.ipynb"\n' > lifecycle.sh

      - name: üß¨ Create or update lifecycle configuration in SageMaker
        run: |
          BASE64_SCRIPT=$(base64 -w 0 lifecycle.sh)
          aws sagemaker create-notebook-instance-lifecycle-config \
            --notebook-instance-lifecycle-config-name $LIFECYCLE_CONFIG_NAME \
            --on-start Content="$BASE64_SCRIPT" || echo "‚ö†Ô∏è Lifecycle config exists, updating..."

          aws sagemaker update-notebook-instance \
            --notebook-instance-name $INSTANCE_NAME \
            --notebook-instance-lifecycle-config-name $LIFECYCLE_CONFIG_NAME

      - name: üöÄ Start the notebook instance
        run: |
          aws sagemaker start-notebook-instance \
            --notebook-instance-name $INSTANCE_NAME
